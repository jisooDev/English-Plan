{% include 'script-t.html' %}

<style>
    #main-practice {
        height: 100%;
        width: 100%;
        background-size: cover;
        background-repeat: no-repeat;
        position: relative;
        z-index: 5;
        background-position: bottom;
    }

    .card-practice {
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        background: #000;
        margin-top: 0 -30px;
        border-radius: 25px;
        position: relative;
    }

    .card-practice .card-practice-header {
        display: flex;
        align-items: flex-end;
        height: 40px;
        margin: 0 25px;
        color: #fff;
    }

    .card-practice .card-practice-body {
        background: #fff;
        margin: 15px;
        padding: 15px 25px 50px;
        border-radius: 25px;
        text-align: center;
    }

    .card-practice .card-practice-body .card-exam-content {
        min-height: 400px;
    }

    .flex-items-center {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .circular-counter {
        height: 90px;
        width: 90px;
        left: calc(50% - 45px);
        display: flex !important;
        position: absolute !important;
        top: -40px;
        border: 5px solid #fff;
        border-radius: 50%;
        background: #fff;
    }

    .progress {
        overflow: inherit;
        background: none;
        width: 80px;
        height: 80px;
    }

    .circle-progress-value {
        stroke-width: 15px;
        stroke: #ED548F;
    }

    .circle-progress-circle {
        stroke-width: 15px;
    }

    .circle-progress {
        width: 80px;
        height: 80px;
    }

    .circle-progress-text {
        font-size: 20px;
        fill: hsl(0, 0%, 0%);
    }

    .circle-progress-text-separator {
        margin-left: 2px;
        margin-right: 2px;
    }
</style>
<body style="font-family: 'Mitr', sans-serif; font-weight: 300;">
    {% include 'header.html' %}

    <div id="main-practice"
        style="background-image: url('{{ url_for('static', filename='image/background-wave-top.svg') }}');">
        <div class="container">
            <div style="height: 80vh;">

                <div class="card-practice">
                    <div class="card-practice-header">
                        <div class="d-none d-lg-block header-name w-100">
                            Welcome Develops!
                        </div>
                        <div class="header-selection w-100 d-flex justify-content-between justify-content-lg-end ">
                            <select class="form-control custom-select" name="a" id="select_difficulty">
                            </select>
                            <select class="form-control custom-select" name="v" id="select_type">
                            </select>

                        </div>

                        <div class="circular-counter">

                            <div class="progress"></div>
                        </div>
                    </div>
                    <div class="card-practice-body">

                        <div class="timer" id="timer"></div>
                        <div class="card-exam-content" id="practice-content">

                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>


    {% include 'login-register.html' %}
    {% include 'script-b.html' %}
    {% raw %}
    <script>
        let practiceData, practiceDetail, countdownInterval;
        let practiceLength = 0;
        let tasks = 'all';
        let difficulty = 'all';
        let premium = true;
        let practiceState = "practicing";
        let timeLimit = false;
        let packageData = false;
        $(async ($) => {


            let package = await checkPackage();
            if (package.success) {
                packageData = package;
                if (package.have_package && package.is_login) {
                    renderSelectDifficulty();
                    renderSelectType();
                    $('#select_difficulty').on('change', () => {
                        const value = $('#select_difficulty').val();
                        localStorage.setItem('sd', window.btoa(value));
                        difficulty = value;
                        checkStarting(true);
                    });
                    $('#select_type').on('change', (event) => {
                        const value = $('#select_type').val();
                        localStorage.setItem('st', window.btoa(value));
                        tasks = value;
                        checkStarting(true);
                    });
                } else {
                    renderSelectDifficultyLock();
                    renderSelectTypeLock();
                }
            } else {
                renderSelectDifficultyLock();
                renderSelectTypeLock();
            }

            checkStarting(false);

        });


        function renderSelectDifficulty() {
            const container = $('#select_difficulty');
            container.empty();
            container.append('<option value="all" selected>All</option>');
            container.append('<option value="easy">Easy </option>');
            container.append('<option value="medium ">medium </option>');
            container.append('<option value="difficult">Hard</option>');
            if (localStorage.getItem('sd')) {
                let value = window.atob(localStorage.getItem('sd'));
                difficulty = value;
                container.val(value);
            } else {
                container.val('all');
            }

        }

        function renderSelectDifficultyLock() {
            const container = $('#select_difficulty');
            container.empty();
            container.append('<option value="all" selected>All</option>');
            container.append('<option value="easy" disabled>&#xf023; Easy </option>');
            container.append('<option value="medium " disabled>&#xf023; medium </option>');
            container.append('<option value="difficult" disabled>&#xf023; Hard</option>');
        }

        function renderSelectType() {
            const container = $('#select_type');
            container.empty();
            container.append('<option value="all">All</option>');
            container.append('<option value="reading">Interactive Reading</option>');
            container.append('<option value="matching">Match the right information</option>');
            container.append('<option value="reading_select_real_eng_word">Choose Real English Words Only</option>');
            container.append('<option value="fill_in_blank">Fill in The Blank</option>');
            container.append('<option value="short_answer">Write following topic</option>');
            container.append('<option value="describe_a_photo">Write following photo</option>');
            container.append('<option value="write_down_what_you_hear">Write down what you hear</option>');
            container.append('<option value="listen_select_real_eng_word">Choose Real English Words Only</option>');
            container.append('<option value="interactive_conversation">Interactive Conversation</option>');
            container.append('<option value="read_aloud">Read the text within 20 seconds</option>');

            if (localStorage.getItem('st')) {
                let value = window.atob(localStorage.getItem('st'));
                tasks = value;
                container.val(value);
            } else {
                container.val('all');
            }

        }

        function renderSelectTypeLock() {
            const container = $('#select_type');
            container.empty();
            container.append('<option value="all" selected>All</option>');
            container.append('<option value="reading" disabled>&#xf023; Interactive Reading</option>');
            container.append('<option value="matching" disabled>&#xf023; Match the right information</option>');
            container.append('<option value="reading_select_real_eng_word" disabled>&#xf023; Choose Real English Words Only</option>');
            container.append('<option value="fill_in_blank" disabled>&#xf023; Fill in The Blank</option>');
            container.append('<option value="short_answer" disabled>&#xf023; Write following topic</option>');
            container.append('<option value="describe_a_photo" disabled>&#xf023; Write following photo</option>');
            container.append('<option value="write_down_what_you_hear" disabled>&#xf023; Write down what you hear</option>');
            container.append('<option value="listen_select_real_eng_word" disabled>&#xf023; Choose Real English Words Only</option>');
            container.append('<option value="interactive_conversation" disabled>&#xf023; Interactive Conversation</option>');
            container.append('<option value="read_aloud" disabled>&#xf023; Read the text within 20 seconds</option>');

        }


        function checkStarting(startNew) {
            if (packageData && packageData.is_login) {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                if (urlParams.get('time_limit') === 'true') {
                    timeLimit = true;
                }
                if (urlParams.get('start') === 'true') {
                    startPractice(startNew, false);
                } else {
                    renderLandingReady();
                }
            } else {
                renderLandingReady();
            }

        }

        function renderLandingReady() {
            const container = $('#practice-content');
            container.empty();
            container.append($('<h2>').addClass('ready-header mt-5 mb-5').text('Are you ready?'));
            container.append($('<p>').addClass('ready-content mb-5').html('With your current plan you only get access to <span>15 sample questions</span>,</br>so think carefully and use them wisely!'));
            let row = $('<div>').addClass('row justify-content-center').hide();
            let colLeft = $('<div>').addClass('col-auto');
            let colRight = $('<div>').addClass('col-auto');
            let btnLeft = $('<button>').addClass('btn btn-primary').text('Time limit').click(function () {
                window.location = '/exam?start=true&time_limit=true';
            });
            let btnRight = $('<button>').addClass('btn btn-primary').text('No time limit').click(function () {
                window.location = '/exam?start=true&time_limit=false';
            });
            colLeft.append(btnLeft);
            colRight.append(btnRight);
            row.append(colLeft);
            row.append(colRight);
            container.append($('<button>').addClass('btn btn-primary btn-start').text('Begin Exam').attr('type', 'button').click(function () {
                if (packageData && packageData.is_login) {
                    $(this).hide();
                    row.show();
                } else {
                    alert('Please login!')
                }


            }));
            container.append(row);
            container.append($('<p>').addClass('ready-promote mt-5').html('If you need more exam,</br>upgrade for <span>5,000+</span> questions'));

        }

        async function checkPracticeProcess(tasks, difficulty, premium) {
            let process = localStorage.getItem('practice');
            if (!process) {
                return false;
            } else {
                let processObj = JSON.parse(window.atob(process));
                if (processObj.tasks == tasks && processObj.difficulty == difficulty && processObj.premium == premium) {
                    return processObj
                } else {
                    return false;
                }
            }
        }

        async function createPracticeProcess(tasks, difficulty, premium, practiceList, total) {
            let data = {
                actualNumber: 1,
                number: 1,
                practice: practiceList,
                tasks: tasks,
                difficulty: difficulty,
                premium: premium,
                total: total,
            }
            localStorage.setItem('practice', window.btoa(JSON.stringify(data)));
            return data
        }

        async function updatePraticeProcess(number, actualNumber) {
            if (number) {
                practiceData.number = practiceData.number + 1;
            }
            if (actualNumber) {
                practiceData.actualNumber = practiceData.actualNumber + 1;
            }
            localStorage.setItem('practice', window.btoa(JSON.stringify(practiceData)));
            return practiceData
        }

        function getPracticeList(tasks, difficulty, premium) {
            const url = 'api/exam/list';
            const data = {
                tasks: tasks,
                difficulty: difficulty,
                premium: premium
            };
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            };
            return new Promise((resolve, reject) => {
                fetch(url, options).then(response => response.json()).then(data => {
                    resolve(data)
                }).catch(error => {
                    reject(error)
                });
            });
        }

        function getPracticeDeatail(practiceId, examId) {
            const params = new URLSearchParams({
                practice_id: practiceId,
                exam_id: examId
            });
            const url = 'api/exam/detail?' + params;

            const options = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            };
            return new Promise((resolve, reject) => {
                fetch(url, options,).then(response => response.json()).then(data => {
                    resolve(data)
                }).catch(error => {
                    reject(error)
                });
            });
        }


        function checkPackage() {
            const url = 'api/package/check';

            const options = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            };
            return new Promise((resolve, reject) => {
                fetch(url, options).then(response => response.json()).then(data => {
                    resolve(data)
                }).catch(error => {
                    reject(error)
                });
            });
        }

        async function renderPracticeCycle(number) {
            $('.progress').circleProgress(
                {
                    max: practiceLength,
                    value: number,
                }
            );
        }

        async function startPractice(startNew, next) {
            if (startNew) {
                localStorage.removeItem('_cc');
                let data = await getPracticeList(tasks, difficulty, premium);
                if (data.success) {
                    practiceData = await createPracticeProcess(tasks, difficulty, premium, data.data, data.total);
                }
            } else {
                let check = await checkPracticeProcess(tasks, difficulty, premium);
                if (check) {
                    practiceData = check;
                    if (next) {
                        localStorage.removeItem('_cc');
                        await updatePraticeProcess(true, true);
                    }

                } else {
                    let data = await getPracticeList(tasks, difficulty, premium);
                    if (data.success) {
                        practiceData = await createPracticeProcess(tasks, difficulty, premium, data.data, data.total);
                    } else {
                        practiceData = false;
                    }
                }
            }

            if (practiceData) {
                practiceLength = practiceData.total;
                await renderPracticeCycle(practiceData.actualNumber);

                let currentPractice = practiceData.practice[practiceData.number - 1];
                let detail = await getPracticeDeatail(currentPractice.practice_id, currentPractice.exam_id);
                if (detail.success) {
                    practiceDetail = detail.data;
                    initRender();
                }
            }
        }

        async function initRender() {
            const container = $('#practice-content');
            container.empty();
            practiceState = "practicing";
            if (practiceDetail.limited_time) {
                await renderTimer(practiceDetail.timer);
            } else {
                await renderTimer(0);
            }
            await renderDifficulty();
            await renderBox();
            switch (practiceDetail.practice_type) {
                case 'reading':
                    await renderPraticeReading();
                    break;
                case 'matching':
                    await renderPraticeMatching();
                    break;
                case 'reading_select_real_eng_word':
                    await renderPraticeReadingSelectRealEngWord();
                    break;
                case 'fill_in_blank':
                    await renderPraticeFillInBlank();
                    break;
                case 'short_answer':
                    await renderPraticeShortAnswer();
                    break;
                case 'describe_a_photo':
                    await renderPraticeDescribeAPhoto();
                    break;
                case 'write_down_what_you_hear':
                    await renderPraticeWriteDownWhatYouHear();
                    break;
                case 'listen_select_real_eng_word':
                    await renderPraticeListenSelectRealEngWord();
                    break;
                case 'interactive_conversation':
                    await renderPraticeInteractiveConversation();
                    break;
                case 'read_aloud':
                    await renderPraticeReadAloud();
                    break;
            }
        }

        async function retryPractice() {
            initRender();
        }

        async function getAudio(url) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(url);
                // audio.play()
                resolve(audio);
            });
        }

        async function submitPractice() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            if (practiceState === "practicing") {
                practiceState = "finished";
                $('#btn-submit').hide();

                switch (practiceDetail.practice_type) {
                    case 'reading':
                        await checkAnswerPraticeReading();
                        break;
                    case 'matching':
                        await checkAnswerPraticeMatching();
                        break;
                    case 'reading_select_real_eng_word':
                        await checkAnswerPraticeReadingSelectRealEngWord();
                        break;
                    case 'fill_in_blank':
                        await checkAnswerPraticeFillInBlank();
                        break;
                    case 'short_answer':
                        await checkAnswerPraticeShortAnswer();
                        break;
                    case 'describe_a_photo':
                        await checkAnswerPraticeeDescribeAPhoto();
                        break;
                    case 'write_down_what_you_hear':
                        await checkAnswerPraticeWriteDownWhatYouHear();
                        break;
                    case 'listen_select_real_eng_word':
                        await checkAnswerPraticeListenSelectRealEngWord();
                        break;
                    case 'interactive_conversation':
                        await checkAnswerPraticeInteractiveConversation();
                        break;
                    case 'read_aloud':
                        await checkAnswerPraticeReadAloud();
                        break;
                }
                await renderFooter();
            }
        }

        async function renderDifficulty() {
            const container = $('#practice-content');
            let row = $('<div>').addClass('row justify-content-end mt-3 mb-2');
            let col = $('<div>').addClass('col-auto');
            row.append(col);
            let diff = $('<div>').addClass('badge-difficulty').text(practiceDetail.difficulty);
            col.append(diff)
            container.append(row);
        }

        async function renderBox() {
            const container = $('#practice-content');
            let box1 = $('<div>').addClass('question-box').attr('id', 'question-box');
            let box2 = $('<div>').addClass('answer-box').attr('id', 'answer-box').hide();
            let box3 = $('<div>').addClass('button-box mt-5 pb-4').attr('id', 'button-box');
            container.append(box1);
            container.append(box2);
            container.append(box3);
        }

        async function renderTimer(cooldownSeconds) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            if (timeLimit) {
                const container = $('#timer');
                let row = $('<div>').addClass('row justify-content-end');
                let col = $('<div>').addClass('col-auto');
                row.append(col);
                let timer = $('<div>').attr('id', 'countdown-timer').addClass('countdown-timer');
                col.append(timer)
                container.append(row);
                const countdownTimer = $('#countdown-timer');

                if (cooldownSeconds > 0) {
                    let remainingSeconds = cooldownSeconds;

                    const startMinutes = Math.floor(remainingSeconds / 60);
                    const startSeconds = remainingSeconds % 60;
                    let text = `${startMinutes.toString().padStart(2, "0")}:${startSeconds.toString().padStart(2, "0")}`;
                    countdownTimer.text(text);
                    countdownInterval = setInterval(async () => {
                        if (remainingSeconds <= 0) {
                            clearInterval(countdownInterval);
                            countdownTimer.text("00:00");
                            await submitPractice();
                        } else {
                            remainingSeconds--;
                            const minutes = Math.floor(remainingSeconds / 60);
                            const seconds = remainingSeconds % 60;
                            let text = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                            countdownTimer.text(text);
                        }
                    }, 1000);
                } else {
                    countdownTimer.text('No limit!');
                }
            }
        }

        async function renderButton() {
            const container = $('#button-box');
            let row = $('<div>').addClass('row justify-content-between ');
            let colLeft = $('<div>').addClass('col-auto');
            let btnRetry = $('<button>').addClass('btn btn-dark btn-round').text('RETRY').unbind('click').bind('click', function () {
                retryPractice();
            });
            colLeft.append(btnRetry);
            let colRight = $('<div>').addClass('col-auto');
            let btnSubmit = $('<button>').attr('id', 'btn-submit').addClass('btn btn-dark btn-round').text('SUBMIT').unbind('click').bind('click', function () {
                submitPractice();
            });
            colRight.append(btnSubmit);

            row.append(colLeft);
            row.append(colRight);

            container.append(row);
        }

        function countWords(str) {
            const words = str.trim().split(/\s+/);
            return words.length;
        }

        async function renderFooter() {
            const container = $('#practice-content');
            let row = $('<div>').addClass('row justify-content-end mt-3');

            let col = $('<div>').addClass('col-auto practice-footer');
            let button
            if (practiceData.total > practiceData.actualNumber) {
                button = $('<button>').addClass('btn btn-primary btn-round').text('Next Exam').unbind('click').bind('click', function () {
                    startPractice(false, true);
                });
            } else {
                button = $('<button>').addClass('btn btn-primary btn-round').text('Finish').unbind('click').bind('click', function () {
                    localStorage.removeItem('_cc');
                    localStorage.removeItem('practice')
                    window.location = '/exam';
                });
            }

            col.append(button);
            row.append(col);
            container.append(row);
        }


        // =========================== 1. section reading start ========================================================
        async function renderPraticeReading() {

            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let count = 0;
            if (localStorage.getItem('_cc')) {
                count = parseInt(localStorage.getItem('_cc'));
            }
            renderPracticeCycle(practiceData.actualNumber);
            let item = practiceDetail.data[count]
            let row1 = $('<div>').addClass('row justify-content-between');
            let col1 = $('<div>').addClass('col-md-12');
            let questionCtn = $('<div>').addClass('question-container mt-4 mb-3');
            let questionText = '<span>' + (count + 1) + ')</span>&nbsp;' + item.question;
            let questionContent = $('<div>').addClass('question-content').attr('question-id', item.id).html(questionText);
            questionCtn.append(questionContent);
            col1.append(questionCtn);
            row1.append(col1);
            container.append(row1);
            if (item.answer_type === 'select') {
                let row2 = $('<div>').addClass('row justify-content-between');
                let col2 = $('<div>').addClass('col-md-12');
                let answerCtn = $('<div>').addClass('answer-container mt-4');
                item.option.forEach((option, j) => {
                    const letters = String.fromCharCode(j + 1 + 96);
                    let text = '<span>' + letters + ')</span>&nbsp;' + option.value;
                    let optionContent = $('<div>').attr('question-id', item.id).attr('option-id', option.id).addClass('option-content').html(text).unbind('click').bind('click', function () {
                        if (practiceState === "practicing") {
                            $(`div[question-id="${item.id}"].selected`).removeClass('selected');
                            $(this).addClass('selected');
                            practiceDetail.data[count].answered = $(this).attr('option-id');
                        }
                    });
                    answerCtn.append(optionContent);
                });
                col2.append(answerCtn);
                row2.append(col2);
                container.append(row2);
            }
            if (item.answer_type === 'type') {
                let row2 = $('<div>').addClass('row justify-content-between');
                let col2 = $('<div>').addClass('col-md-12');
                let answerCtn = $('<div>').addClass('answer-container');
                let textArea = $('<textarea>').attr('id', 'practice-textarea').addClass('practice-textarea form-control').on('input', function (event) {
                    const wordCount = countWords(textArea.val());
                    if (wordCount > 0) {
                        practiceDetail.data[count].answered = textArea.val();
                    }
                    $('#word-count').text(`Word count: ${wordCount}`);
                });
                let wc = $('<p>').attr('id', 'word-count').addClass('words-count mb-5 text-start').text('Word count: 0');
                answerCtn.append(textArea);
                answerCtn.append(wc);
                col2.append(answerCtn);
                row2.append(col2);
                container.append(row2);
            }
            if ((count + 1) < practiceDetail.data.length) {
                let row3 = $('<div>').addClass('row justify-content-end');
                let col3 = $('<div>').addClass('col-auto');
                let button = $('<button>').addClass('btn btn-primary btn-round').text('Next').unbind('click').bind('click', function () {
                    localStorage.setItem('_cc', count + 1);
                    updatePraticeProcess(false, true);
                    renderPraticeReading();
                });
                col3.append(button);
                row3.append(col3);
                container.append(row3);
            } else {
                renderButton();
            }

        }

        async function checkAnswerPraticeReading() {
            const container = $('#practice-content');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 mb-5 p-name').text(practiceDetail.practice_name);
            let div = $('<div>').addClass('answer-box mb-5');
            practiceDetail.data.forEach((item, i) => {
                let questionText = '<span>' + (i + 1) + ')</span>&nbsp;' + item.question;
                let row = $('<div>').addClass('row justify-content-between answer-item');
                let col1 = $('<div>').addClass('col-12').html(questionText)
                let col2 = $('<div>').addClass('col-12 badge-answer-box');
                if (item.answer_type === 'select') {
                    item.option.forEach((option, j) => {
                        let answer = window.atob(item.answer)
                        const letters = String.fromCharCode(j + 1 + 96);
                        let text = '<span>' + letters + ')</span>&nbsp;' + option.value;
                        let badge = $('<span>').addClass('badge-answer').html(text);
                        if (answer == option.id) {
                            badge.addClass('correct');
                        }
                        if (item.answered && (item.answered == option.id)) {
                            badge.addClass('selected');
                        }
                        col2.append(badge);
                    })
                }
                if (item.answer_type === 'type') {
                    let badge = $('<span>').addClass('badge-typing').text(item.answered);
                    col2.append(badge);
                }
                row.append(col1);
                row.append(col2);
                if (item.explain) {
                    let explain = $('<div>').html(item.explain).addClass('col-12 badge-answer-explain')
                    row.append(explain);
                }
                div.append(row);
            });
            container.append(div);
        }

        // =========================== 1. section reading end ==========================================================

        // =========================== 2. section matching start ==========================================================

        async function renderPraticeMatching() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);

            let row = $('<div>').addClass('row justify-content-between mt-5');
            let colL = $('<div>').addClass('col-md-6 matching l');
            let colR = $('<div>').addClass('col-md-6 matching r text-start');
            let select = $('<select>').addClass('select-matching');
            let optionEmtry = $('<option>').text("").attr('value', "");
            select.append(optionEmtry);
            practiceDetail.options.forEach((item, i) => {
                const letters = String.fromCharCode(i + 1 + 96);
                let text = '<span>' + letters + ')</span>&nbsp;' + item.value;
                let p = $('<p>').attr('id', `o-${item.id}`).html(`<span id="b-${item.id}"></span>&nbsp;${text}`).addClass('matching-value');
                let option = $('<option>').text(letters).attr('value', item.id);
                colR.append(p);
                select.append(option);
            });

            practiceDetail.data.forEach((item, i) => {
                let div = $('<div>').attr('id', item.id).addClass('matching-data');
                let letters = $('<p>').text(`${i + 1})`).addClass('letters');
                select.attr('id', `a-${item.id}`);
                let p = $('<p>').attr('data-id', item.id).text(item.value).addClass('matching-data-text');
                div.append(letters);
                select.clone().appendTo(div);
                div.append(p);
                colL.append(div);
            });


            row.append(colL);
            row.append(colR);
            container.append(row);
            $('.select-matching').on('change', function () {
                const div = $(this).closest('div');
                div.attr('data-option', `o-${$(this).val()}`);
                const selects = $('.select-matching');
                const selected = countSelectedOptions(selects);
                practiceDetail.options.forEach((item) => {
                    const count = selected[item.id];
                    $(`#b-${item.id}`).removeClass('success fail')
                    if (count == 1) {
                        $(`#b-${item.id}`).addClass('success').html('<i class="fa fa-check"></i>');
                    }
                    else if (count > 1) {
                        $(`#b-${item.id}`).addClass('fail').html('<i class="fa fa-warning"></i>');
                    }
                });
                practiceDetail.data.forEach((item, index) => {
                    item['answered'] = $(selects[index]).val()
                });
            });
            $('.matching-data-text').unbind('click').bind('click', function () {
                $('.matching-data').removeClass('selected');
                const div = $(this).closest('div');
                div.addClass('selected');
                const value = $(`#a-${$(this).attr('data-id')}`).val();
                $('.matching-value').removeClass('selected')
                $(`#o-${value}`).addClass('selected');
            });

            $('.matching-value').unbind('click').bind('click', function () {
                $('.matching-value').removeClass('selected');
                const div = $(this).closest('div');
                $(this).addClass('selected');
                $('.matching-data').removeClass('selected');
                $(`div[data-option="${$(this).attr('id')}"].matching-data`).addClass('selected');

            });

            await renderButton();

        }
        function countSelectedOptions(selects) {
            const counts = {};
            selects.each(function () {
                const selectedValue = $(this).val();
                if (selectedValue !== '') {
                    if (counts[selectedValue]) {
                        counts[selectedValue]++;
                    } else {
                        counts[selectedValue] = 1;
                    }
                }
            });

            return counts;
        }


        async function checkAnswerPraticeMatching() {
            // $('.practice-box').hide();
            let box = $('.answer-box');
            let cAnswerHeader = $('<div>').addClass('a-header').html('Correct Answer');
            let hr = $('<hr>');
            let cAnswerContent = $('<p>').addClass('a-content').html(practiceDetail.story);
            practiceDetail.data.forEach((item, i) => {
                let row = $('<div>').addClass('row justify-content-between answer-item');
                let col1 = $('<div>').addClass('col-auto').text(`# ${(i + 1)}`)
                let col2 = $('<div>').addClass('col-auto');
                if (item.answered && (item.answered == window.atob(item.answer))) {
                    let badge = $('<span>').addClass('badge-correct').text('Correct');
                    col2.append(badge);
                } else {
                    let badge = $('<span>').addClass('badge-incorrect').text('Incorrect');
                    col2.append(badge);
                }
                row.append(col1);
                row.append(col2);
                cAnswerContent.append(row);
            });

            box.append(cAnswerHeader);
            box.append(hr);
            box.append(cAnswerContent);
            box.show();
        }

        // =========================== 2. section matching end ==========================================================

        // =========================== 3. section reading_select_real_eng_word start ==========================================================

        async function renderPraticeReadingSelectRealEngWord() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let row = $('<div>').addClass('real-word-box mt-5');


            practiceDetail.data.forEach((item, i) => {
                let col = $('<div>')
                let box = $('<div>').addClass('real-word-item').attr('word-id', item.id).text(item.value).unbind('click').bind('click', function () {
                    if (practiceState === 'practicing') {
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                        } else {
                            $(this).addClass('selected');
                        }
                    }

                });
                col.append(box);
                row.append(col);
            })
            container.append(row);
            await renderButton();
        }

        async function checkAnswerPraticeReadingSelectRealEngWord() {
            practiceDetail.data.forEach((item, i) => {
                let answer = window.atob(item.answer);
                if (answer === 'correct') {
                    let ans = $(`div[word-id="${item.id}"]`).addClass('correct');
                } else {
                    let ans = $(`div[word-id="${item.id}"]`).addClass('incorrect');
                }

            });
        }


        // =========================== 3. section reading_select_real_eng_word end ==========================================================

        // =========================== 4. section fill_in_blank start ==========================================================

        async function renderPraticeFillInBlank() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);

            let row = $('<div>').addClass('row justify-content-center mt-5 mb-5');
            let col = $('<div>').addClass('col-auto fill-in-blank');
            const renderedSentence = practiceDetail.data.replace(/{{\d+}}/g, (match) => {
                const number = parseInt(match.match(/\d+/)[0], 10);
                let data = practiceDetail.answer[number];

                if (data.show) {
                    let value = window.atob(data.value);
                    return `<input type="text" class="blank free" value="${value}" maxlength="1" disabled>`;
                } else {
                    return '<input type="text" class="blank" maxlength="1">';
                }
            });

            col.append(renderedSentence);
            row.append(col);
            container.append(row);
            addEventListeners();
            await renderButton();
        }

        function addEventListeners() {
            const blanks = $('.blank');
            blanks.each((index, blank) => {
                $(blank).keyup((e) => handleKeyPress(e, index, blanks));
            });
        }

        function handleKeyPress(e, index, blanks) {
            if (practiceState === 'practicing') {
                const key = e.key;
                const value = e.target.value;
                if (key.length === 1 && value.length === 1) {
                    if (index < blanks.length - 1) {
                        let nextIndex = index + 1;
                        while (blanks[nextIndex] && blanks[nextIndex].hasAttribute('disabled')) {
                            nextIndex++;
                        }
                        if (blanks[nextIndex]) {
                            blanks[nextIndex].focus();
                        }
                    }
                } else if (key === 'Backspace' && value.length === 0) {
                    if (index > 0) {
                        let prevIndex = index - 1;
                        while (blanks[prevIndex] && blanks[prevIndex].hasAttribute('disabled')) {
                            prevIndex--;
                        }
                        if (blanks[prevIndex]) {
                            blanks[prevIndex].focus();
                        }
                    }
                }
            }
        }

        async function checkAnswerPraticeFillInBlank() {
            const blanks = $('.blank');
            blanks.each((index, blank) => {
                $(blank).prop('disabled', true);
                if (!$(blank).hasClass('free')) {
                    const userAnswer = blank.value.trim().toLowerCase();
                    const correctAnswer = window.atob(practiceDetail.answer[index].value);
                    if (userAnswer === correctAnswer) {
                        $(blank).addClass('correct')
                    } else {
                        $(blank).addClass('incorrect')
                    }
                }
            });

            const result = practiceDetail.data.replace(/(\{{\d+\}})+/g, (match) => {
                const matchedNumbers = match.match(/\d+/g);
                let text = '<span class="blank-answer">'
                matchedNumbers.forEach((number) => {
                    const index = parseInt(number, 10);
                    let value = window.atob(practiceDetail.answer[index].value);
                    text += value;
                });
                text += '</span>';
                return text;
            });

            let box = $('.answer-box');
            let cAnswerHeader = $('<div>').addClass('a-header').html('Correct Answer');
            let cAnswerContent = $('<p>').addClass('a-content').html(result);
            box.append(cAnswerHeader);
            box.append(cAnswerContent);
            box.show();
        }

        // =========================== 4. section fill_in_blank end ==========================================================

        // =========================== 5. section short_answer start ==========================================================


        async function renderPraticeShortAnswer() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let p = $('<p>').addClass('topic mt-5 mb-5').text(practiceDetail.data);
            container.append(p);
            let textArea = $('<textarea>').attr('id', 'practice-textarea').addClass('practice-textarea form-control').on('input', function (event) {
                const wordCount = countWords(textArea.val());
                $('#word-count').text(`Word count: ${wordCount}`);
            });
            let wc = $('<p>').attr('id', 'word-count').addClass('words-count mb-5 text-start').text('Word count: 0');
            container.append(textArea);
            container.append(wc);
            await renderButton();

        }

        async function checkAnswerPraticeShortAnswer() {
            let box = $('.answer-box');
            let yAnswerHeader = $('<div>').addClass('a-header').html('Your Answer');
            let yAnswerContent = $('<p>').addClass('a-content').html($('#practice-textarea').val());
            let hr = $('<hr>')
            let cAnswerHeader = $('<div>').addClass('a-header').html('Example Answer');
            let cAnswerContent = $('<p>').addClass('a-content').html(window.atob(practiceDetail.answer));
            box.append(yAnswerHeader);
            box.append(yAnswerContent);
            box.append(hr);
            box.append(cAnswerHeader);
            box.append(cAnswerContent);
            box.show();
            $('#practice-textarea').hide();
            $('#word-count').hide();
        }

        // =========================== 5. section short_answer end ==========================================================

        // =========================== 6. section describe_a_photo start ==========================================================


        async function renderPraticeDescribeAPhoto() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let image = $('<img>').addClass('image-box mt-5 mb-5').attr('src', practiceDetail.data);
            container.append(image);
            let textArea = $('<textarea>').attr('id', 'practice-textarea').addClass('practice-textarea form-control').on('input', function (event) {
                const wordCount = countWords(textArea.val());
                $('#word-count').text(`Word count: ${wordCount}`);
            });
            let wc = $('<p>').attr('id', 'word-count').addClass('words-count mb-5 text-start').text('Word count: 0');
            container.append(textArea);
            container.append(wc);
            await renderButton();
        }

        async function checkAnswerPraticeeDescribeAPhoto() {
            let box = $('.answer-box');
            let yAnswerHeader = $('<div>').addClass('a-header').html('Your Answer');
            let yAnswerContent = $('<p>').addClass('a-content').html($('#practice-textarea').val());
            let hr = $('<hr>')
            let cAnswerHeader = $('<div>').addClass('a-header').html('Example Answer');
            let cAnswerContent = $('<p>').addClass('a-content').html(window.atob(practiceDetail.answer));
            box.append(yAnswerHeader);
            box.append(yAnswerContent);
            box.append(hr);
            box.append(cAnswerHeader);
            box.append(cAnswerContent);
            box.show();
            $('#practice-textarea').hide();
            $('#word-count').hide();
        }

        // =========================== 6. section describe_a_photo end ==========================================================

        // =========================== 7. section write_down_what_you_hear start ==========================================================


        async function renderPraticeWriteDownWhatYouHear() {
            let playingAudio = false;
            const container = $('#question-box');
            container.empty();
            let audio = await getAudio(practiceDetail.data);
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let row = $('<div>').addClass('row justify-content-center mt-5 mb-5');
            let col = $('<div>').addClass('col-auto');
            let button = $('<div>').addClass('btn-play').unbind('click').bind('click', function () {
                if (!playingAudio) {
                    audio.play();
                    playingAudio = true;
                    button.empty();
                    let icon = $('<i>').addClass('pause fa fa-pause-circle-o fa-lg');
                    button.append(icon);
                    audio.addEventListener('ended', () => {
                        playingAudio = false;
                        button.empty();
                        let icon = $('<i>').addClass('play fa fa-play-circle-o fa-lg');
                        button.append(icon);
                    });
                } else {
                    audio.pause();
                    playingAudio = false;
                    button.empty();
                    let icon = $('<i>').addClass('play fa fa-play-circle-o fa-lg');
                    button.append(icon);
                }
            });
            let icon = $('<i>').addClass('play fa fa-play-circle-o fa-lg');
            button.append(icon);
            col.append(button);
            row.append(col);
            container.append(row);
            let textArea = $('<textarea>').attr('id', 'practice-textarea').addClass('practice-textarea form-control').on('input', function (event) {
                const wordCount = countWords(textArea.val());
                $('#word-count').text(`Word count: ${wordCount}`);
            });
            let wc = $('<p>').attr('id', 'word-count').addClass('words-count mb-5 text-start').text('Word count: 0');
            container.append(textArea);
            container.append(wc);
            await renderButton();
        }

        async function checkAnswerPraticeWriteDownWhatYouHear() {
            let box = $('.answer-box');
            let yAnswerHeader = $('<div>').addClass('a-header').html('Your Answer');
            let yAnswerContent = $('<p>').addClass('a-content').html($('#practice-textarea').val());
            let hr = $('<hr>')
            let cAnswerHeader = $('<div>').addClass('a-header').html('Correct Answer');
            let cAnswerContent = $('<p>').addClass('a-content').html(window.atob(practiceDetail.answer));
            box.append(yAnswerHeader);
            box.append(yAnswerContent);
            box.append(hr);
            box.append(cAnswerHeader);
            box.append(cAnswerContent);
            box.show();
            $('#practice-textarea').hide();
            $('#word-count').hide();
        }

        // =========================== 7. section write_down_what_you_hear end ==========================================================

        // =========================== 8. section listen_select_real_eng_word start ==========================================================


        async function renderPraticeListenSelectRealEngWord() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let row = $('<div>').addClass('row justify-content-center mt-5 mb-5');

            practiceDetail.data.forEach(async (item, i) => {
                let audio = await getAudio(item.value);
                let col = $('<div>').addClass('col-sm-2 col-md-4');
                let box = $('<div>').addClass('l-word-item').attr('word-id', item.id);
                let play = $('<div>').addClass('play').html('<i class="fa fa-volume-off"></i>').unbind('click').bind('click', function () {
                    play.empty();
                    play.html('<i class="fa fa-volume-up"></i>');
                    audio.play();
                    audio.addEventListener('ended', () => {
                        play.empty();
                        play.html('<i class="fa fa-volume-off"></i>');
                    });
                });
                let label = $('<div>').addClass('label').text('');
                let select = $('<div>').addClass('selection').html('<i class="fa fa-check"></i>').unbind('click').bind('click', function () {
                    if (practiceState === 'practicing') {
                        if (box.hasClass('selected')) {
                            box.removeClass('selected');
                        } else {
                            box.addClass('selected');
                        }
                    }
                });
                box.append(play);
                box.append(label);
                box.append(select);
                col.append(box);
                row.append(col);
            });
            container.append(row);
            await renderButton();

        }

        async function checkAnswerPraticeListenSelectRealEngWord() {
            practiceDetail.data.forEach((item, i) => {
                let answer = window.atob(item.answer);
                if (answer === 'correct') {
                    $(`div[word-id="${item.id}"]`).addClass('correct');
                    $(`div[word-id="${item.id}"] .label`).text(item.name);
                } else {
                    $(`div[word-id="${item.id}"]`).addClass('incorrect');
                    $(`div[word-id="${item.id}"] .label`).text(item.name);
                }

            });
        }

        // =========================== 8. section listen_select_real_eng_word end ==========================================================

        // =========================== 9. section interactive_conversation start ==========================================================


        async function renderPraticeInteractiveConversation() {
            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);

            let count = 0;
            if (localStorage.getItem('_cc')) {
                count = parseInt(localStorage.getItem('_cc'));
            }

            let audio = await getAudio(practiceDetail.data[count].audio);
            let playingAudio = false;
            renderPracticeCycle(practiceData.actualNumber);
            let hRow = $('<div>').addClass('row justify-content-center mt-3 mb-3');
            let hCol = $('<div>').addClass('col-auto');
            let hButton = $('<div>').addClass('btn-play small').unbind('click').bind('click', async () => {
                if (!playingAudio) {
                    audio.play();
                    playingAudio = true;
                    hButton.empty();
                    let icon = $('<i>').addClass('pause fa fa-pause-circle-o fa-lg');
                    hButton.append(icon);
                    audio.addEventListener('ended', () => {
                        playingAudio = false;
                        hButton.empty();
                        let icon = $('<i>').addClass('play fa fa-play-circle-o fa-lg');
                        hButton.append(icon);
                    });
                } else {
                    audio.pause();
                    playingAudio = false;
                    hButton.empty();
                    let icon = $('<i>').addClass('play fa fa-play-circle-o fa-lg');
                    hButton.append(icon);
                }
            });
            let icon = $('<i>').addClass('play fa fa-play-circle-o fa-lg');
            hButton.append(icon);
            hCol.append(hButton);
            hRow.append(hCol);
            container.append(hRow);
            let item = practiceDetail.data[count]
            let row1 = $('<div>').addClass('row justify-content-between');
            let col1 = $('<div>').addClass('col-md-12');
            let questionCtn = $('<div>').addClass('question-container');
            let questionText = '<span>' + (count + 1) + ')</span>&nbsp;' + item.question;
            let questionContent = $('<div>').addClass('question-content').attr('question-id', item.id).html(questionText);
            questionCtn.append(questionContent);
            col1.append(questionCtn);
            row1.append(col1);
            container.append(row1);
            if (item.answer_type === 'select') {
                let row2 = $('<div>').addClass('row justify-content-between');
                let col2 = $('<div>').addClass('col-md-12');
                let answerCtn = $('<div>').addClass('answer-container');
                item.option.forEach((option, j) => {
                    const letters = String.fromCharCode(j + 1 + 96);
                    let text = '<span>' + letters + ')</span>&nbsp;' + option.value;
                    let optionContent = $('<div>').attr('question-id', item.id).attr('option-id', option.id).addClass('option-content').html(text).unbind('click').bind('click', function () {
                        if (practiceState === "practicing") {
                            $(`div[question-id="${item.id}"].selected`).removeClass('selected');
                            $(this).addClass('selected');
                            practiceDetail.data[count].answered = true;
                        }
                    });
                    answerCtn.append(optionContent);
                });
                col2.append(answerCtn);
                row2.append(col2);
                container.append(row2);
            }
            if (item.answer_type === 'type') {
                let row2 = $('<div>').addClass('row justify-content-between');
                let col2 = $('<div>').addClass('col-md-12');
                let answerCtn = $('<div>').addClass('answer-container');
                let textArea = $('<textarea>').attr('id', 'practice-textarea').addClass('practice-textarea form-control').on('input', function (event) {
                    const wordCount = countWords(textArea.val());
                    if (wordCount > 0) {
                        practiceDetail.data[count].answered = textArea.val();
                    }
                    $('#word-count').text(`Word count: ${wordCount}`);
                });
                let wc = $('<p>').attr('id', 'word-count').addClass('words-count text-start').text('Word count: 0');
                answerCtn.append(textArea);
                answerCtn.append(wc);
                col2.append(answerCtn);
                row2.append(col2);
                container.append(row2);
            }
            if ((count + 1) < practiceDetail.data.length) {
                let row3 = $('<div>').addClass('row justify-content-end');
                let col3 = $('<div>').addClass('col-auto');
                let button = $('<button>').addClass('btn btn-primary').text('Next').unbind('click').bind('click', function () {
                    localStorage.setItem('_cc', count + 1);
                    updatePraticeProcess(false, true);
                    renderPraticeInteractiveConversation();
                });
                col3.append(button);
                row3.append(col3);
                container.append(row3);
            } else {
                renderButton();
            }
        }

        async function checkAnswerPraticeInteractiveConversation() {
            const container = $('#practice-content');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 mb-5 p-name').text(practiceDetail.practice_name);
            let div = $('<div>').addClass('answer-box mb-5');
            practiceDetail.data.forEach((item, i) => {
                let questionText = '<span>' + (i + 1) + ')</span>&nbsp;' + item.question;
                let row = $('<div>').addClass('row justify-content-between answer-item');
                let col1 = $('<div>').addClass('col-12').html(questionText)
                let col2 = $('<div>').addClass('col-12 badge-answer-box');
                if (item.answer_type === 'select') {
                    item.option.forEach((option, j) => {
                        let answer = window.atob(item.answer)
                        const letters = String.fromCharCode(j + 1 + 96);
                        let text = '<span>' + letters + ')</span>&nbsp;' + option.value;
                        let badge = $('<span>').addClass('badge-answer').html(text);
                        if (answer == option.id) {
                            badge.addClass('correct');
                        }
                        if (item.answered && (item.answered == option.id)) {
                            badge.addClass('selected');
                        }
                        col2.append(badge);
                    })
                }
                if (item.answer_type === 'type') {
                    let badge = $('<span>').addClass('badge-typing').text(item.answered);
                    col2.append(badge);
                }
                row.append(col1);
                row.append(col2);
                if (item.explain) {
                    let explain = $('<div>').html(item.explain).addClass('col-12 badge-answer-explain')
                    row.append(explain);
                }

                div.append(row);
            });
            container.append(div);
        }

        // =========================== 9. section interactive_conversation end ==========================================================

        // =========================== 10. section read_aloud start ==========================================================


        async function renderPraticeReadAloud() {

            let mediaRecorder;
            let chunks = [];
            let startTime;

            const container = $('#question-box');
            container.empty();
            let pName = $('<h5>').addClass('text-center mt-4 p-name').text(practiceDetail.practice_name);
            container.append(pName);
            let question = $('<p>').addClass('text-start mt-5 mb-4').text(practiceDetail.data);
            container.append(question);
            let row = $('<div>').addClass('row justify-content-center mt-5 mb-5');
            let col = $('<div>').addClass('col-auto');
            let timer = $('<p>').text('00:00')
            let speakStart = $('<div>').addClass('btn-media').html('<i class="fa fa-solid fa-microphone"></i>').unbind('click').bind('click', async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                startTime = Date.now();

                mediaRecorder.addEventListener("dataavailable", (event) => {
                    chunks.push(event.data);
                });

                const timerInterval = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    const minutes = Math.floor(elapsedTime / 60000);
                    const seconds = Math.floor((elapsedTime % 60000) / 1000);
                    timer.text(`${minutes < 10 ? "0" : ""}${minutes}:${seconds < 10 ? "0" : ""}${seconds}`);
                }, 1000);

                // Stop the time counter when the recording is stopped
                mediaRecorder.addEventListener("stop", async () => {
                    clearInterval(timerInterval);
                    timer.hide()
                    let audioPlayback = $('<audio controls>').attr('id', 'audio-playback');
                    col.append(audioPlayback);
                    const blob = new Blob(chunks, { type: "audio/ogg; codecs=opus" });
                    audioPlayback.attr('src', URL.createObjectURL(blob));
                    await renderButton();
                    submitPractice();
                });
                speakStart.hide();
                speakStop.show();
            });


            let speakStop = $('<div>').addClass('btn-media').html('<i class="fa fa-solid fa-pause"></i>').unbind('click').bind('click', async () => {
                mediaRecorder.stop();
                speakStop.hide();

            }).hide();

            col.append(speakStart);
            col.append(speakStop);
            col.append(timer);
            row.append(col);
            container.append(row);


        }

        async function checkAnswerPraticeReadAloud() {
            let box = $('.answer-box');
            let yAnswerHeader = $('<div>').addClass('a-header').html('Your Answer');
            let yAnswerContent = $('<p>').addClass('a-content').html($('#practice-textarea').val());
            let hr = $('<hr>')
            let cAnswerHeader = $('<div>').addClass('a-header').html('Example Answer');
            let answerAudio = $('<audio controls>').attr('id', 'audio-answer').attr('src', practiceDetail.audio).addClass('answer-audio');
            let cAnswerContent = $('<p>').addClass('a-content').html(window.atob(practiceDetail.answer));
            // box.append(yAnswerHeader);
            // box.append(yAnswerContent);
            // box.append(hr);
            box.append(cAnswerHeader);
            box.append(answerAudio);
            box.append(cAnswerContent);
            box.show();

        }


        // =========================== 10. section read_aloud end ==========================================================




    </script>
    {% endraw %}
</body>
</html>