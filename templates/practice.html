{% include 'script-t.html' %}

<style>
    #main-practice {
        height: 100%;
        width: 100%;
        background-size: cover;
        background-repeat: no-repeat;
        position: relative;
        z-index: 5;
        background-position: bottom;
    }

    .card-practice {
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        background: #000;
        margin-top: 0 -30px;
        border-radius: 25px;
        position: relative;
    }

    .card-practice .card-practice-header {
        display: flex;
        align-items: flex-end;
        height: 40px;
        margin: 0 25px;
        color: #fff;
    }

    .card-practice .card-practice-body {
        background: #fff;
        margin: 15px;
        padding: 15px 25px 50px;
        border-radius: 25px;
        text-align: center;
    }

    .card-practice .card-practice-body .card-exam-content {
        height: 400px;
    }

    .flex-items-center {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .circular-counter {
        height: 90px;
        width: 90px;
        left: calc(50% - 50px);
        display: flex !important;
        position: absolute !important;
        top: -40px;
        border: 5px solid #fff;
        border-radius: 50%;
        background: #fff;
    }

    .progress {
        overflow: inherit;
        background: none;
        width: 80px;
        height: 80px;
    }

    .circle-progress-value {
        stroke-width: 15px;
        stroke: #ED548F;
    }

    .circle-progress-circle {
        stroke-width: 15px;
    }

    .circle-progress {
        width: 80px;
        height: 80px;
    }

    .circle-progress-text {
        font-size: 20px;
        fill: hsl(0, 0%, 0%);
    }

    .circle-progress-text-separator {
        margin-left: 2px;
        margin-right: 2px;
    }

    .story {
        text-align: start;
        text-indent: 1.5em;
    }

    .answer-content.selected {
        font-weight: bold;
    }
</style>
<body>
    {% include 'header.html' %}

    <div id="main-practice"
        style="background-image: url('{{ url_for('static', filename='image/background-wave-top.svg') }}');">
        <div class="container">
            <div style="height: 80vh;">

                <div class="card-practice">
                    <div class="card-practice-header">
                        <div class="d-none d-lg-block header-name w-100">
                            Welcome Develops!
                        </div>
                        <div class="header-selection w-100 d-flex justify-content-between justify-content-lg-end">
                            <select class="from-control" name="" id="">
                                <option value="">selected</option>
                            </select>
                            <select class="from-control" name="" id="">
                                <option value="">selected</option>
                            </select>
                        </div>

                        <div class="circular-counter">

                            <div class="progress"></div>
                        </div>
                    </div>
                    <div class="card-practice-body">


                        <div class="card-exam-content" id="practice-content">

                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>



    {% include 'script-b.html' %}
    <script>
        let practiceData, practiceDetail, countdownInterval;
        let practiceLength = 0;
        let tasks = 'all';
        let difficulty = 'all';
        let premium = true;
        $(function ($) {
            $('.progress').circleProgress(
                {
                    max: 15,
                    value: practiceLength,
                }
            );
            checkStarting();
        });

        function checkStarting() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            console.log(urlParams);
            if (urlParams.get('start') === 'true') {
                startPractice();
            } else {
                renderLandingReady();
            }
        }

        function renderLandingReady() {
            const container = $('#practice-content');
            container.empty();
            container.append($('<div>').addClass('ready-headline'));
            container.append($('<h5>').addClass('ready-header').text('Are you ready?'));
            container.append($('<p>').addClass('ready-content').html('With your current plan you only get access to <span>15 sample questions</span>,</br>so think carefully and use them wisely!'));
            container.append($('<button>').addClass('btn btn-start').text('Begin Practice').attr('type', 'button').click(function () {
                window.location = '/practice?start=true';
            }));
            container.append($('<p>').addClass('ready-promote').html('If you need more practice,</br>upgrade for <span>5,000+</span> questions'));

        }

        async function checkPracticeProcess(tasks, difficulty, premium) {
            let process = localStorage.getItem('practice');
            if (!process) {
                return false;
            } else {
                let processObj = JSON.parse(window.atob(process));
                if (processObj.tasks == tasks && processObj.difficulty == difficulty && processObj.premium == premium) {
                    return processObj
                } else {
                    return false;
                }
            }
        }

        async function createPracticeProcess(tasks, difficulty, premium, practiceList, practiceNumber) {
            console.log(tasks)
            let data = {
                number: practiceNumber,
                practice: practiceList,
                tasks: tasks,
                difficulty: difficulty,
                premium: premium,
            }
            localStorage.setItem('practice', window.btoa(JSON.stringify(data)));
            return data
        }

        function getPracticeList(tasks, difficulty, premium) {
            const url = 'api/practice/list';
            const data = {
                tasks: tasks,
                difficulty: difficulty,
                premium: premium
            };
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            };
            return new Promise((resolve, reject) => {
                fetch(url, options).then(response => response.json()).then(data => {
                    resolve(data)
                }).catch(error => {
                    reject(error)
                });
            });
        }
        function getPracticeDeatail(practiceId, practiceType) {
            const params = new URLSearchParams({
                practice_id: practiceId,
                practice_type: practiceType,
            });
            const url = 'api/practice/detail?' + params;

            const options = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            };
            return new Promise((resolve, reject) => {
                fetch(url, options,).then(response => response.json()).then(data => {
                    resolve(data)
                }).catch(error => {
                    reject(error)
                });
            });
        }

        async function renderPracticeCycle(number) {
            console.log('renderPracticeCycle', number)
            $('.progress').circleProgress(
                {
                    max: practiceLength,
                    value: number,
                }
            );
        }

        async function startPractice() {
            let check = await checkPracticeProcess(tasks, difficulty, premium);
            if (check) {
                console.log('continue practice')
                practiceData = check;
            } else {
                let data = await getPracticeList(tasks, difficulty, premium);
                console.log(data)
                if (data.success) {
                    practiceData = await createPracticeProcess(tasks, difficulty, premium, data.data, 1);
                }
            }
            if (practiceData) {
                console.log('go go go')
                console.log(practiceData)
                practiceLength = practiceData.practice.length;
                await renderPracticeCycle(practiceData.number);

                let currentPractice = practiceData.practice[practiceData.number - 1];
                console.log(currentPractice)
                let detail = await getPracticeDeatail(currentPractice.practice_id, currentPractice.practice_type);
                if (detail.success) {
                    practiceDetail = detail.data
                    const container = $('#practice-content');
                    container.empty();

                    if (practiceDetail.practice_type === 'reading') {
                        await renderPraticeReading();
                    }
                }

            }

        }

        async function renderTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            const container = $('#practice-content');
            let row = $('<div>').addClass('row justify-content-end');
            let col = $('<div>').addClass('col-auto');
            row.append(col);
            let timer = $('<div>').attr('id', 'countdown-timer');
            col.append(timer)
            container.append(row);

            const cooldownSeconds = practiceDetail.timer;
            let remainingSeconds = cooldownSeconds;
            const countdownTimer = $('#countdown-timer');
            countdownInterval = setInterval(async () => {
                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownTimer.text("Cooldown over!");
                    await submitPractice();
                } else {
                    remainingSeconds--;
                    const minutes = Math.floor(remainingSeconds / 60);
                    const seconds = remainingSeconds % 60;
                    let text = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                    countdownTimer.text(text);
                }
            }, 1000);
        }

        async function renderButton() {
            const container = $('#practice-content');
            let row = $('<div>').addClass('row justify-content-between');
            let colLeft = $('<div>').addClass('col-auto');
            let btnRetry = $('<button>').addClass('btn btn-dark').text('RETRY').unbind('click').bind('click', function () {
                retryPractice();
            });
            colLeft.append(btnRetry);
            let colRight = $('<div>').addClass('col-auto');
            let btnSubmit = $('<button>').addClass('btn btn-dark').text('SUBMIT').unbind('click').bind('click', function () {
                submitPractice();
            });
            colRight.append(btnSubmit);


            row.append(colLeft);
            row.append(colRight);

            container.append(row);
        }
        async function retryPractice() {
            console.log('retryPractice')
            if (practiceDetail.practice_type === 'reading') {
                await renderPraticeReading();
            }
        }

        async function submitPractice() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            if (practiceDetail.practice_type === 'reading') {
                await checkAnswerReading();
            }
            console.log('submitPractice')
        }



        async function renderPraticeReading() {
            console.log(practiceDetail)
            const container = $('#practice-content');
            container.empty();
            await renderTimer();

            let row = $('<div>').addClass('row justify-content-between');

            let colLeft = $('<div>').addClass('col-md-6 story');
            let story = $('<p>').text(practiceDetail.story)
            colLeft.append(story);

            let colRight = $('<div>').addClass('col-md-6');

            practiceDetail.quiz.forEach((quiz, i) => {
                console.log(quiz)
                let questionCtn = $('<div>').addClass('question-container');
                let questionText = '<span>' + (i + 1) + ')</span>&nbsp;' + quiz.question;
                let questionContent = $('<div>').addClass('question-content').attr('question-id', quiz.id).attr('ans', quiz.answer).html(questionText);
                questionCtn.append(questionContent);
                let answerCtn = $('<div>').addClass('answer-container');
                console.log(window.atob(quiz.answer))
                quiz.choice.forEach((choice, j) => {
                    const letters = String.fromCharCode(j + 1 + 96);

                    let text = '<span>' + letters + ')</span>&nbsp;' + choice.value;
                    let choiceContent = $('<div>').attr('question-id', quiz.id).attr('choice-id', choice.id).addClass('answer-content').html(text).unbind('click').bind('click', function () {
                        console.log('click choice')
                        $(`div[question-id="${quiz.id}"].selected`).removeClass('selected');
                        $(this).addClass('selected');
                    });
                    answerCtn.append(choiceContent);
                });
                questionCtn.append(answerCtn);
                colRight.append(questionCtn);

            });



            row.append(colLeft);
            row.append(colRight);
            container.append(row);

            await renderButton();
        }

        async function checkAnswerReading() {
            console.log('checkAnswerReading');
            practiceDetail.quiz.forEach((quiz, i) => {
                const correctChoice = window.atob(quiz.answer);
                console.log(correctChoice)
            })

        }





    </script>
</body>
</html>